---
phase: 04-environment-variable
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/audit-milestone.md
  - commands/gsd/debug.md
  - commands/gsd/execute-phase.md
  - commands/gsd/new-milestone.md
  - commands/gsd/new-project.md
  - commands/gsd/plan-phase.md
  - commands/gsd/quick.md
  - commands/gsd/research-phase.md
autonomous: true

must_haves:
  truths:
    - "GSD_DEFAULT_MODEL_PROFILE env var is read when config.json has no model_profile"
    - "config.json model_profile takes precedence over env var"
    - "Fallback to 'balanced' when neither config.json nor env var is set"
    - "All 8 command files use identical bash pattern"
  artifacts:
    - path: "commands/gsd/audit-milestone.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "commands/gsd/debug.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "commands/gsd/execute-phase.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "commands/gsd/new-milestone.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "commands/gsd/new-project.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "commands/gsd/plan-phase.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "commands/gsd/quick.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "commands/gsd/research-phase.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
  key_links:
    - from: "commands/gsd/*.md"
      to: "GSD_DEFAULT_MODEL_PROFILE"
      via: "bash parameter expansion"
      pattern: "\\$\\{CONFIG_PROFILE:-\\$\\{GSD_DEFAULT_MODEL_PROFILE:-balanced\\}\\}"
---

<objective>
Update all 8 command files to support GSD_DEFAULT_MODEL_PROFILE environment variable with proper fallback chain.

Purpose: Enable users to set a default model profile via environment variable that applies when no config.json model_profile is set.
Output: 8 command files with updated MODEL_PROFILE resolution pattern.
</objective>

<execution_context>
@/Users/vmakaev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vmakaev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-environment-variable/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MODEL_PROFILE pattern in 8 command files</name>
  <files>
    commands/gsd/audit-milestone.md
    commands/gsd/debug.md
    commands/gsd/execute-phase.md
    commands/gsd/new-milestone.md
    commands/gsd/new-project.md
    commands/gsd/plan-phase.md
    commands/gsd/quick.md
    commands/gsd/research-phase.md
  </files>
  <action>
In each of the 8 command files, find the MODEL_PROFILE pattern:

```bash
MODEL_PROFILE=$(cat .planning/config.json 2>/dev/null | grep -o '"model_profile"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "balanced")
```

Replace with the two-line pattern:

```bash
# Read from config.json (may be empty if not set)
CONFIG_PROFILE=$(cat .planning/config.json 2>/dev/null | grep -o '"model_profile"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"')
# Fallback chain: config.json -> env var -> "balanced"
MODEL_PROFILE="${CONFIG_PROFILE:-${GSD_DEFAULT_MODEL_PROFILE:-balanced}}"
```

CRITICAL: Remove the `|| echo "balanced"` from the first line. If left in, CONFIG_PROFILE always has a value and the env var fallback is unreachable.

Note: Each file has the pattern in a slightly different section:
- audit-milestone.md: Step 0. Resolve Model Profile
- debug.md: Resolve model profile section
- execute-phase.md: Step 0 or early in process
- new-milestone.md: Model profile resolution
- new-project.md: Model profile resolution
- plan-phase.md: Step 1 Resolve Model Profile
- quick.md: Model profile resolution
- research-phase.md: Model profile resolution

Preserve the surrounding context and markdown formatting in each file.
  </action>
  <verify>
Run grep to confirm all 8 files have the new pattern:

```bash
grep -l 'GSD_DEFAULT_MODEL_PROFILE' commands/gsd/audit-milestone.md commands/gsd/debug.md commands/gsd/execute-phase.md commands/gsd/new-milestone.md commands/gsd/new-project.md commands/gsd/plan-phase.md commands/gsd/quick.md commands/gsd/research-phase.md | wc -l
```

Expected: 8

Confirm no files still have the old pattern:

```bash
grep -l '|| echo "balanced"' commands/gsd/audit-milestone.md commands/gsd/debug.md commands/gsd/execute-phase.md commands/gsd/new-milestone.md commands/gsd/new-project.md commands/gsd/plan-phase.md commands/gsd/quick.md commands/gsd/research-phase.md 2>/dev/null | wc -l
```

Expected: 0
  </verify>
  <done>
All 8 command files contain the two-line MODEL_PROFILE pattern with GSD_DEFAULT_MODEL_PROFILE fallback, and none contain the old `|| echo "balanced"` pattern.
  </done>
</task>

</tasks>

<verification>
1. All 8 command files updated with new pattern
2. No files retain the old `|| echo "balanced"` pattern
3. Pattern is identical across all 8 files (consistent implementation)
</verification>

<success_criteria>
- grep for 'GSD_DEFAULT_MODEL_PROFILE' matches 8 command files
- grep for 'CONFIG_PROFILE' matches 8 command files
- grep for '|| echo "balanced"' matches 0 command files
- Each file has exactly 2 lines for the pattern (CONFIG_PROFILE assignment + MODEL_PROFILE assignment)
</success_criteria>

<output>
After completion, create `.planning/phases/04-environment-variable/04-01-SUMMARY.md`
</output>
