---
phase: 04-environment-variable
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/workflows/execute-phase.md
  - get-shit-done/workflows/execute-plan.md
  - get-shit-done/workflows/map-codebase.md
  - get-shit-done/workflows/verify-work.md
autonomous: true

must_haves:
  truths:
    - "GSD_DEFAULT_MODEL_PROFILE env var is read when config.json has no model_profile"
    - "config.json model_profile takes precedence over env var"
    - "Fallback to 'balanced' when neither config.json nor env var is set"
    - "All 4 workflow files use identical bash pattern"
  artifacts:
    - path: "get-shit-done/workflows/execute-phase.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "get-shit-done/workflows/execute-plan.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "get-shit-done/workflows/map-codebase.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
    - path: "get-shit-done/workflows/verify-work.md"
      provides: "Model profile resolution with env var fallback"
      contains: "GSD_DEFAULT_MODEL_PROFILE"
  key_links:
    - from: "get-shit-done/workflows/*.md"
      to: "GSD_DEFAULT_MODEL_PROFILE"
      via: "bash parameter expansion"
      pattern: "\\$\\{CONFIG_PROFILE:-\\$\\{GSD_DEFAULT_MODEL_PROFILE:-balanced\\}\\}"
---

<objective>
Update all 4 workflow files to support GSD_DEFAULT_MODEL_PROFILE environment variable with proper fallback chain.

Purpose: Enable users to set a default model profile via environment variable that applies when no config.json model_profile is set.
Output: 4 workflow files with updated MODEL_PROFILE resolution pattern.
</objective>

<execution_context>
@/Users/vmakaev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vmakaev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-environment-variable/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MODEL_PROFILE pattern in 4 workflow files</name>
  <files>
    get-shit-done/workflows/execute-phase.md
    get-shit-done/workflows/execute-plan.md
    get-shit-done/workflows/map-codebase.md
    get-shit-done/workflows/verify-work.md
  </files>
  <action>
In each of the 4 workflow files, find the MODEL_PROFILE pattern:

```bash
MODEL_PROFILE=$(cat .planning/config.json 2>/dev/null | grep -o '"model_profile"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "balanced")
```

Replace with the two-line pattern:

```bash
# Read from config.json (may be empty if not set)
CONFIG_PROFILE=$(cat .planning/config.json 2>/dev/null | grep -o '"model_profile"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"')
# Fallback chain: config.json -> env var -> "balanced"
MODEL_PROFILE="${CONFIG_PROFILE:-${GSD_DEFAULT_MODEL_PROFILE:-balanced}}"
```

CRITICAL: Remove the `|| echo "balanced"` from the first line. If left in, CONFIG_PROFILE always has a value and the env var fallback is unreachable.

Note: Each workflow file has the pattern in a `resolve_model_profile` step or similar section. Preserve the surrounding context and markdown formatting.
  </action>
  <verify>
Run grep to confirm all 4 files have the new pattern:

```bash
grep -l 'GSD_DEFAULT_MODEL_PROFILE' get-shit-done/workflows/execute-phase.md get-shit-done/workflows/execute-plan.md get-shit-done/workflows/map-codebase.md get-shit-done/workflows/verify-work.md | wc -l
```

Expected: 4

Confirm no files still have the old pattern:

```bash
grep -l '|| echo "balanced"' get-shit-done/workflows/execute-phase.md get-shit-done/workflows/execute-plan.md get-shit-done/workflows/map-codebase.md get-shit-done/workflows/verify-work.md 2>/dev/null | wc -l
```

Expected: 0
  </verify>
  <done>
All 4 workflow files contain the two-line MODEL_PROFILE pattern with GSD_DEFAULT_MODEL_PROFILE fallback, and none contain the old `|| echo "balanced"` pattern.
  </done>
</task>

</tasks>

<verification>
1. All 4 workflow files updated with new pattern
2. No files retain the old `|| echo "balanced"` pattern
3. Pattern is identical across all 4 files (consistent implementation)
</verification>

<success_criteria>
- grep for 'GSD_DEFAULT_MODEL_PROFILE' matches 4 workflow files
- grep for 'CONFIG_PROFILE' matches 4 workflow files
- grep for '|| echo "balanced"' matches 0 workflow files
- Each file has exactly 2 lines for the pattern (CONFIG_PROFILE assignment + MODEL_PROFILE assignment)
</success_criteria>

<output>
After completion, create `.planning/phases/04-environment-variable/04-02-SUMMARY.md`
</output>
